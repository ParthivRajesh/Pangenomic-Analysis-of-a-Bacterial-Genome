############################################
# 0. GO TO PROJECT DIRECTORY
############################################

# Set your project root directory (EDIT THIS)
PROJECT_DIR="/path/to/Pangenomic_Analysis"

cd "$PROJECT_DIR"

# Optional: check contents
ls
# You should see: ncbi_dataset/, maybe Prokka/, etc.


############################################
# 1. GO TO NCBI DATA FOLDER AND BUILD genomes.txt
############################################

# This is where NCBI Datasets unpacked everything
# Typically something like: $PROJECT_DIR/ncbi_dataset/ncbi_dataset/data
NCBI_DATA_DIR="$PROJECT_DIR/ncbi_dataset/ncbi_dataset/data"

cd "$NCBI_DATA_DIR"

# Confirm the GCF_* folders are here
ls

# Create genomes.txt with only the main genomic FASTA files
# (excluding CDS and RNA sub-fastas)
rm genomes.txt 2>/dev/null

find . -name "*genomic.fna" -type f \
  | grep -v "cds_from_genomic" \
  | grep -v "rna_from_genomic" \
  > genomes.txt

# Quick sanity check
head genomes.txt
wc -l genomes.txt


############################################
# 2. MAKE PROKKA OUTPUT DIRECTORY
############################################

mkdir -p prokka_output


############################################
# 3. RUN PROKKA ON ALL GENOMES (USING genomes.txt)
############################################

# Assumes:
# - Your conda env with Prokka is already activated (e.g. `conda activate pangenome_env`)
# - `prokka` is on PATH

while read genome; do
  genome_id=$(basename "$(dirname "$genome")")
  echo "Annotating $genome_id..."

  prokka --outdir "prokka_output/$genome_id" \
         --prefix "$genome_id" \
         --cpus 4 \
         "$genome"

done < genomes.txt

# After this, you should have:
# prokka_output/GCF_XXXXXX.Y/ with .gff, .gbk, .faa, etc, for each genome.


############################################
# 4. RUN ROARY (FROM PROJECT ROOT, USING PROKKA GFFs)
############################################

cd "$PROJECT_DIR"

# Roary output directory
mkdir -p roary_output

# Path to Prokka GFFs relative to project root
# If prokka_output is inside $NCBI_DATA_DIR but you want a clean Prokka/ folder,
# you can symlink or move; here we assume:
#   $PROJECT_DIR/Prokka/prokka_output/*/*.gff
# Adjust this path to wherever your Prokka outputs actually live.
PROKKA_GFF_GLOB="$PROJECT_DIR/Prokka/prokka_output/*/*.gff"

roary -f ./roary_output -e -n -v -p 8 "$PROKKA_GFF_GLOB"


############################################
# 5. DOWNLOAD roary_plots.py
############################################

cd "$PROJECT_DIR"

# Download helper plotting script from the Roary GitHub repository
wget https://github.com/sanger-pathogens/Roary/blob/master/contrib/roary_plots/roary_plots.py

# Make executable (optional)
chmod +x roary_plots.py


############################################
# 6. INSTALL PYTHON DEPENDENCIES IN CONDA ENV
############################################

# Activate your env (name is generic; change if needed)
# conda activate pangenome_env

# Install plotting dependencies (if not already installed)
# conda install matplotlib seaborn biopython numpy -y
# or:
# pip install matplotlib seaborn biopython numpy


############################################
# 7. GENERATE PLOTS WITH roary_plots.py
############################################

# Roary often creates a run-specific subfolder inside roary_output,
# e.g. roary_output/_1765126508/
# Set this to where your two files actually are:
#   accessory_binary_genes.fa.newick
#   gene_presence_absence.csv

ROARY_RUN_DIR="$PROJECT_DIR/roary_output/_RUN_ID_HERE"

python3 roary_plots.py \
  "$ROARY_RUN_DIR/accessory_binary_genes.fa.newick" \
  "$ROARY_RUN_DIR/gene_presence_absence.csv"


############################################
# 8. DONE
############################################

# You now have:
# - Annotated genomes from Prokka in prokka_output/
# - Roary pangenome results in roary_output/
# - Plots generated by roary_plots.py
